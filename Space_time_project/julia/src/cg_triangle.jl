module cg_triangle 
using LinearAlgebra
using StartUpDG

function quad_from_triangle_SBP(n,xi1,eta1,P1,Qxi1,Qeta1,Exi1,Eeta1)
    """
    Purpose: construct a quad SBP operator using two triangle SBP operators 
             using the cg approach 

    Inputs: 
    n           : number of nodes in the input triangle element 
    xi1, eta1   : nodal distribution of the input triangle element 
    P1, 
    Qxi1, Qeta1, 
    Exi1, Eeta1 : SBP operators for the input triangle element 
    
    Outputs: 
    XI, ETA     : nodal distribution for the output quad element 
    Pg, 
    Qxig, Qetag, 
    Exig, Eetag : output SBP operatotors
    """

    #first clean the nodal distributions, i.e., remove things that are almost zero 
    for i=1:n
        if(abs(xi1[i,1])<=10^(-12)) 
            xi1[i,1] = 0.0
        end
        if(abs(eta1[i,1])<=10^(-12)) 
            eta1[i,1] = 0.0
        end
    end
    xi2 = -xi1
    eta2 = -eta1

    # clean up the nodal distribution for the second triangle (same idea as above)
    for i=1:n
        if(abs(xi2[i,1])<=10^(-12)) 
            xi2[i,1] = 0.0
        end
        if(abs(eta1[i,1])<=10^(-12)) 
            eta2[i,1] = 0.0
        end
    end
    #-- first determine the number of common points (probably dont need this)
    count = 0
    for i =1:n 
        for j = 1:n 
            if (xi1[i,1]==xi2[j,1]) && (eta1[i,1]==eta2[j,1])
                count+=1
            end
        end 
    end

    XI = zeros(2*n-count,1)
    ETA = zeros(2*n-count,1)


    input = []

    for i = 1:n 
        push!(input,(xi1[i,1],eta1[i,1]))
    end
    for i = 1:n 
        push!(input,(xi2[i,1],eta2[i,1]))
    end
    ordered = unique(input)
 

    for i = 1:2*n-count #size(ordered)[1]
        XI[i,1] = ordered[i][1]
        ETA[i,1] = ordered[i][2]
    end

    #-- construct the mapping operators from global to local 
    Ig2l1 = global_to_local(2*n-count,n,xi1,eta1,XI,ETA)
    Ig2l2 = global_to_local(2*n-count,n,xi2,eta2,XI,ETA)
 
    #-- need to carefully think about the transformation here
    Qxig = transpose(Ig2l1)*Qxi1*Ig2l1-transpose(Ig2l2)*Qxi1*Ig2l2
    Qetag = transpose(Ig2l1)*Qeta1*Ig2l1-transpose(Ig2l2)*Qeta1*Ig2l2
    Exig = transpose(Ig2l1)*Exi1*Ig2l1-transpose(Ig2l2)*Exi1*Ig2l2
    Eetag = transpose(Ig2l1)*Eeta1*Ig2l1-transpose(Ig2l2)*Eeta1*Ig2l2
    Pg = transpose(Ig2l1)*P1*Ig2l1+transpose(Ig2l2)*P1*Ig2l2
    return XI, ETA, Pg, Qxig, Qetag, Exig, Eetag
end

function global_first_derivative_operators(xL,xR,yB,yT,Nx,Ny,p)
    """
    Purpose: to construct the nodal distribution and SBP operators 
             on a quad mesh constructed from triangles using a CG 
             approach 

    Inputs: 
    xL, xR, yB, yT: limits of the domain 
    Nx, Ny        : number of elements in the x and y direction respectively
    
    Outputs: 
    xg, yg                : global nodes
    Pg, Qxg, Qyg, Exg, Eyg: global SBP operators 
    """

    # construct the local operator on the triangle 
    xit, etat, Pt, Qxit, Qetat, Exit, Eetat = triangle_from_Jesse(p)
    # construct the local operator on the quad [-1,1]x[1,1]
    nt = size(xit)[1]
    xil, etal, Pl, Qxil, Qetal, Exil, Eetal = quad_from_triangle_SBP(nt,xit,etat,Pt,Qxit,Qetat,Exit,Eetat)
    nl = size(xil)[1]

    # mesh spacing 
    dx = (xR-xL)/Nx 
    dy = (yT-yB)/Ny

    #loop over the mesh and construct the global nodal distribution 
    XY = [] 
    for i = 1:Nx
        for j = 1:Ny
            xLl = xL + (i-1)*dx
            xRl = xL + i*dx
            yBl = yB + (j-1)*dy
            yTl = yB + j*dy

            xl = (xRl-xLl)/2.0*xil  + (xRl+xLl)/2.0*ones(nl,1)
            yl = (yTl-yBl)/2.0*etal + (yTl+yBl)/2.0*ones(nl,1)

            # add the local nodes to the global array
            for k = 1:nl 
                 push!(XY,(xl[k,1],yl[k,1]))
            end
        end
    end

    # find the unique nodes 
    ordered = unique(XY)
    ng = size(ordered)[1]

    #construct arrays that contain the x and y locations of the nodes 
    xg = zeros(ng,1)
    yg = zeros(ng,1)
    for i = 1:ng 
        xg[i,1] = ordered[i][1]
        yg[i,1] = ordered[i][2]
    end

    #create the global operators 
    Pg  = zeros(ng,ng)
    Qxg = zeros(ng,ng)
    Qyg = zeros(ng,ng)
    Exg = zeros(ng,ng)
    Eyg = zeros(ng,ng)

    for i = 1:Nx
        for j = 1:Ny
            xLl = xL + (i-1)*dx
            xRl = xL + i*dx
            yBl = yB + (j-1)*dy
            yTl = yB + j*dy

            xl = (xRl-xLl)/2.0*xil  + (xRl+xLl)/2.0*ones(nl,1)
            yl = (yTl-yBl)/2.0*etal + (yTl+yBl)/2.0*ones(nl,1)

            #add local contributions to the global operators 
            Ig2l = global_to_local(ng,nl,xl,yl,xg,yg)
            Pg  = Pg  + transpose(Ig2l)*((xRl-xLl)/2.0*(yTl-yBl)/2.0 * Pl)*Ig2l 
            Qxg = Qxg + (yTl-yBl)/2.0*transpose(Ig2l)*Qxil*Ig2l  
            Qyg = Qyg + (xRl-xLl)/2.0*transpose(Ig2l)*Qetal*Ig2l  
            Exg = Exg + (yTl-yBl)/2.0*transpose(Ig2l)*Exil*Ig2l  
            Eyg = Eyg + (xRl-xLl)/2.0*transpose(Ig2l)*Eetal*Ig2l  
        end
    end
    return xg, yg, Pg, Qxg, Qyg, Exg, Eyg
end 

function global_to_local(num_nodesg,num_nodesl,xl,yl,xg,yg)
    """
    Purpose: construct a global to local mapping operator 

    Inputs: 
    num_nodesg: global number of nodes 
    num_nodesl: local number of nodes 
    xl, yl    : local nodal distribution 
    xg,yg     : global nodal distribution
    
    Outputs: 
    Ig2l: global to local mapping, note that the 
          local to global mapping is the transpose 
          of this operator
    """

    Ig2l = zeros(num_nodesl,num_nodesg)

    for i = 1:num_nodesl
        for j = 1:num_nodesg
            if(xl[i,1]==xg[j,1])&&(yl[i,1]==yg[j,1])
                Ig2l[i,j] = 1.0
            end
        end
    end
    return Ig2l
end

function triangle_from_Jesse(p)
    """
    Purpose: to construct SBP operators. Note that these are taken from Jesse Chan's 
    StartUpDG.jl code and should correspond to Jason Hicken's diagonal E operators 
    but we need to make sure and understand 

    Outputs: 
    xi, eta: nodal distribution 
    P      : norm matrix 
    Qxi, Qeta: transpose stiffness matricies 
    Exi, Eeta: norm weighted surface mass matricies    
    """
    N = p
    rd = RefElemData(Tri(), SBP{Hicken}(), N)
    xi = rd.r 
    eta = rd.s 
    P = rd.M 
    Dxi = rd.Dr 
    Deta = rd.Ds 
    Qxi = P*Dxi 
    Qeta = P*Deta 
    Exi = Qxi+transpose(Qxi)
    Eeta = Qeta+transpose(Qeta)

    num_nodes = size(xi)[1]

    #-- clean up Qxi, Qeta such that 
    #   you get a clean SBP property 
    Sxi  = Qxi-0.5*Exi 
    Seta = Qeta - 0.5*Eeta
    for i = 1:num_nodes
        for j = 1:num_nodes
            if abs(Exi[i,j]) <= 10^(-13)
                Exi[i,j] = 0.0
            end
            if abs(Eeta[i,j]) <= 10^(-13)
                Eeta[i,j] = 0.0
            end
        end 
    end

    Qxi  = Sxi + 0.5*Exi 
    Qeta = Seta + 0.5*Eeta
    return xi, eta, P, Qxi, Qeta, Exi, Eeta
end

function traingle_omega(p)
    """
    Purpose: to construct SBP omega operators 

    Inputs: 
    p = degree of the operator 

    Outputs: 
    xi, eta: nodal distribution 
    P      : norm matrix 
    Qxi, Qeta: transpose stiffness matricies 
    Exi, Eeta: norm weighted surface mass matricies 
    Note: these do not have diagonal Exi and Eeta
    """
    """
    code to generate operators from SummationByParts
    d = 4
    cub, vtx = getTriCubatureGamma(2*d-1, Float64)
    xy = SymCubatures.calcnodes(cub, vtx)
    x = vec(xy[1,:]); y = vec(xy[2,:])
    w, Q = SummationByParts.buildoperators(cub, vtx, d)
    Qxi = Q[:,:,1]
    Qeta = Q[:,:,2]
    Exi = Qxi + transpose(Qxi)
    Eeta = Qeta + transpose(Qeta)
    P = diagm(w)
    """
    if p == 1
        xi   = [-1.0; 1.0; -1.0]
        eta  = [-1.0; -1.0; 1.0]
        Qxi  = [ -0.3333333333333328  0.3333333333333337    4.440892098500626e-16; 
                 -0.3333333333333337  0.3333333333333325   -6.661338147750939e-16; 
                 -0.3333333333333329  0.33333333333333315   3.3306690738754696e-16]
        Qeta = [ -0.3333333333333325    6.661338147750939e-16   0.3333333333333336; 
                 -0.33333333333333315  -3.3306690738754696e-16  0.33333333333333304;
                 -0.3333333333333336   -5.828670879282072e-16   0.3333333333333328 ]
        P    = [0.6666666666666666  0.0                 0.0;               
                0.0                 0.6666666666666666  0.0;              
                0.0                 0.0                 0.6666666666666666]
        Exi  = Qxi + transpose(Qxi)
        Eeta = Qeta + transpose(Qeta)
    elseif p == 2
        xi = [-1.0; 1.0;-1.0;0.0;0.0;-1.0;-0.3333333333333333]
        eta = [-1.0;-1.0;1.0;-1.0;0.0;0.0;-0.3333333333333333]
        Qxi = [-0.13333333333333336   -0.033333333333333076   0.016666666666666705     0.1333333333333332      -0.06666666666666686     -0.06666666666666643      0.14999999999999997;   
                0.033333333333333076   0.1333333333333333    -0.0166666666666668      -0.13333333333333325      0.06666666666666678      0.06666666666666671     -0.1500000000000002;    
                0.049999999999999975  -0.04999999999999988    5.551115123125783e-17    3.1317836643539765e-17   0.19999999999999968     -0.20000000000000018      1.0351673274173635e-16;
               -0.1333333333333332     0.13333333333333325   -3.1317836643539765e-17   0.0                     -3.8025339200315755e-16   1.5213685423145166e-16   3.77597203524349e-16;  
                0.06666666666666686    0.06666666666666667   -0.06666666666666692      3.8025339200315755e-16   0.533333333333333        2.5498836085130115e-16  -0.6000000000000002;    
               -0.06666666666666635   -0.06666666666666671    0.06666666666666672     -1.5213685423145166e-16  -2.5498836085130115e-16  -0.533333333333333        0.6000000000000008;    
               -0.14999999999999997    0.1500000000000002    -1.0351673274173635e-16  -3.77597203524349e-16     0.6000000000000002      -0.6000000000000008       0.0   ]
        Qeta = [-0.1333333333333333    0.01666666666666679     -0.03333333333333341   -0.06666666666666707     -0.06666666666666683     0.13333333333333322      0.14999999999999988;   
                 0.04999999999999989  -5.551115123125783e-17   -0.050000000000000114  -0.1999999999999995       0.2                     2.862293735361732e-17   -1.1796119636642288e-16;
                 0.03333333333333341  -0.01666666666666657      0.13333333333333336    0.06666666666666667      0.06666666666666632    -0.13333333333333325     -0.15000000000000013;   
                -0.06666666666666637   0.06666666666666672     -0.06666666666666667   -0.533333333333333       -3.86843335142828e-16   -1.0928757898653885e-16   0.6000000000000005;    
                 0.06666666666666683  -0.06666666666666655      0.06666666666666646    3.86843335142828e-16     0.533333333333333       5.621391442178879e-17   -0.6000000000000003;    
                -0.13333333333333322  -2.862293735361732e-17    0.13333333333333325    1.0928757898653885e-16  -5.621391442178879e-17   0.0                      3.0531133177191805e-16;
                -0.14999999999999988   1.1796119636642288e-16   0.15000000000000013   -0.6000000000000005       0.6000000000000003     -3.0531133177191805e-16   0.0]
        P = [0.09999999999999999  0.0                  0.0                  0.0                  0.0                  0.0                  0.0;               
             0.0                  0.09999999999999999  0.0                  0.0                  0.0                  0.0                  0.0;               
             0.0                  0.0                  0.09999999999999999  0.0                  0.0                  0.0                  0.0;               
             0.0                  0.0                  0.0                  0.26666666666666666  0.0                  0.0                  0.0;               
             0.0                  0.0                  0.0                  0.0                  0.26666666666666666  0.0                  0.0;               
             0.0                  0.0                  0.0                  0.0                  0.0                  0.26666666666666666  0.0;               
             0.0                  0.0                  0.0                  0.0                  0.0                  0.0                  0.9000000000000002]
        Exi  = Qxi + transpose(Qxi)
        Eeta = Qeta + transpose(Qeta)
    elseif p == 3
        xi = [-1.0;1.0;-1.0;-0.5853096486728182;-0.5853096486728182;0.17061929734563638;0.4130608881819197;-0.4130608881819197;-0.4130608881819197;0.4130608881819197;-1.0;-1.0]
        eta = [ -1.0;-1.0;1.0;0.17061929734563636;-0.5853096486728182;-0.5853096486728182;-1.0;-1.0;0.4130608881819197;-0.4130608881819197;-0.4130608881819197;0.4130608881819197]
        Qxi = [ -0.0725708114822568     0.008084004712752594  -0.007243403384752131   -0.050703823693264885    0.09822618187774113   -0.04752235818447593    -0.021514820951279264    0.07408078710375807     0.019414964726487845    0.017711042342640874  -0.04886268591248462    0.030900922845134172; 
                -0.008084004712752594   0.07257081148225675    0.007243403384752185    0.050703823693265       0.047522358184476116  -0.09822618187774108    -0.07408078710375798     0.021514820951279094   -0.030900922845133617    0.04886268591248454   -0.017711042342640915  -0.019414964726487963; 
                -0.015327408097504758   0.015327408097504706   5.551115123125783e-17   9.197179185954526e-17  -0.003181465508789016   0.0031814655087888423  -0.001703922383846886    0.0017039223838468559   0.12294347301624249    -0.05241574379641332    0.05241574379641288   -0.12294347301624246;  
                 0.050703823693264885  -0.050703823693265     -9.197179185954526e-17   0.0                    -0.22919442438139598    0.2291944243813958     -0.01192745668692875     0.011927456686928418    0.4583903220216394      0.07820851002813438   -0.07820851002813431   -0.45839032202163993;  
                -0.09822618187774113   -0.047522358184476116   0.003181465508789016    0.22919442438139598     0.0                    0.45838884876279157     0.04927740325744839     0.03734994657051929    -0.08487230475499498    -0.09679976144192419   -0.42104037545112005   -0.028931106770686492; 
                 0.04752235818447593    0.09822618187774108   -0.0031814655087888423  -0.2291944243813958     -0.45838884876279157    0.0                    -0.03734994657051934    -0.04927740325744826     0.02893110677068655     0.4210403754511201     0.0967997614419241     0.08487230475499499;  
                 0.021514820951279264   0.07408078710375798    0.001703922383846886    0.01192745668692875    -0.04927740325744839    0.03734994657051934     0.0                    -0.0927913755578685     -0.0025046929324432222  -0.016120414821021323   0.023448459381402616  -0.009331506508953702; 
                -0.07408078710375807   -0.021514820951279094  -0.0017039223838468559  -0.011927456686928418   -0.03734994657051929    0.04927740325744826     0.0927913755578685      0.0                     0.00933150650895333    -0.023448459381402484   0.016120414821021223   0.0025046929324431797;
                -0.019414964726487845  -0.015385363698448788  -0.04818223017481344    -0.4583903220216394      0.08487230475499498   -0.02893110677068655     0.0025046929324432222  -0.00933150650895333     0.3561292467872805      0.07793526747042202    0.02595315231384572    0.032240829642042515; 
                -0.017711042342640874   0.025898556928944445   0.006129457252830324   -0.07820851002813438     0.09679976144192419   -0.4210403754511201      0.016120414821021323    0.023448459381402484   -0.014856108087446987    0.35612924678728064   -0.01866301301790675    0.025953152313845398; 
                -0.02589855692894443    0.017711042342640915  -0.00612945725283048     0.07820851002813431     0.42104037545112005   -0.0967997614419241     -0.023448459381402616   -0.016120414821021223   -0.02595315231384572     0.01866301301790675   -0.3561292467872805     0.01485610808744666;  
                 0.015385363698448822   0.019414964726487963   0.048182230174813476    0.45839032202163993     0.028931106770686492  -0.08487230475499499     0.009331506508953702   -0.0025046929324431797  -0.032240829642042515   -0.025953152313845398  -0.0779352674704217    -0.35612924678728064 ]
        Qeta = [-0.07257081148225675   -0.007243403384752144    0.00808400471275255   -0.04752235818447592    0.09822618187774117    -0.05070382369326463     0.030900922845133478   -0.04886268591248465    0.017711042342640988   0.019414964726487946    0.0740807871037578     -0.021514820951279035; 
                -0.015327408097504746  -5.551115123125783e-17   0.015327408097504807   0.003181465508788954  -0.0031814655087887157   5.724587470723463e-17  -0.12294347301624263     0.052415743796413214  -0.05241574379641269    0.1229434730162422      0.0017039223838469309  -0.0017039223838468897;
                -0.00808400471275255    0.007243403384752083    0.0725708114822568    -0.09822618187774138    0.04752235818447606     0.05070382369326473    -0.01941496472648778    -0.017711042342640974   0.04886268591248444   -0.03090092284513438     0.021514820951279053   -0.07408078710375784;  
                 0.04752235818447592   -0.003181465508788954    0.09822618187774138    0.0                   -0.4583888487627918     -0.22919442438139578     0.08487230475499527     0.096799761441924      0.4210403754511201     0.028931106770685992   -0.049277403257448095   -0.03734994657051935;  
                -0.09822618187774117    0.0031814655087887157  -0.04752235818447606    0.4583888487627918     0.0                     0.229194424381396      -0.028931106770686627   -0.4210403754511203    -0.09679976144192363   -0.08487230475499542     0.0373499465705194      0.04927740325744785;  
                 0.05070382369326463   -5.724587470723463e-17  -0.05070382369326473    0.22919442438139578   -0.229194424381396       0.0                    -0.4583903220216399     -0.07820851002813438    0.07820851002813473    0.4583903220216394      0.011927456686928756   -0.011927456686928484; 
                 0.015385363698448926   0.04818223017481358     0.01941496472648778   -0.08487230475499527    0.028931106770686627    0.4583903220216399     -0.3561292467872805     -0.07793526747042163   -0.025953152313845745  -0.03224082964204318    -0.0025046929324429447   0.009331506508953154; 
                -0.025898556928944334  -0.006129457252830223    0.017711042342640974  -0.096799761441924      0.4210403754511203      0.07820851002813438     0.014856108087446598   -0.35612924678728064    0.018663013017906883  -0.02595315231384561    -0.0161204148210215     -0.023448459381402498; 
                -0.017711042342640988   0.006129457252830282    0.025898556928944612  -0.4210403754511201     0.09679976144192363    -0.07820851002813473     0.025953152313845745   -0.018663013017906883   0.3561292467872805    -0.014856108087446668    0.023448459381402532    0.01612041482102137;  
                -0.019414964726487946  -0.04818223017481321    -0.015385363698448614  -0.028931106770685992   0.08487230475499542    -0.4583903220216394      0.03224082964204318     0.02595315231384561    0.0779352674704217     0.35612924678728064    -0.009331506508953622    0.0025046929324432435;
                -0.0740807871037578    -0.0017039223838469309  -0.021514820951279053   0.049277403257448095  -0.0373499465705194     -0.011927456686928756    0.0025046929324429447   0.0161204148210215    -0.023448459381402532   0.009331506508953622    0.0                     0.09279137555786852;  
                 0.021514820951279035   0.0017039223838468897   0.07408078710375784    0.03734994657051935   -0.04927740325744785     0.011927456686928484   -0.009331506508953154    0.023448459381402498  -0.01612041482102137   -0.0025046929324432435  -0.09279137555786852     0.0]
        P = [0.02974582604964118  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.02974582604964118  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.02974582604964118  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.4415541156808217  0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.4415541156808217  0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.4415541156808217  0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.09768336246810204  0.0                  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.09768336246810204  0.0                  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.09768336246810204  0.0                  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.09768336246810204  0.0                  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.09768336246810204  0.0;                
             0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.09768336246810204]
        Exi  = Qxi + transpose(Qxi)
        Eeta = Qeta + transpose(Qeta)
    elseif p == 4
        xi = [-1.0;1.0;-1.0;0.0;0.0;-1.0;-0.7384168123405102;-0.7384168123405102;0.4768336246810203;-0.1504720765483788;-0.1504720765483788;-0.6990558469032424;0.5773502691896257;-0.5773502691896257;-0.5773502691896257;0.5773502691896257;-1.0;-1.0]
        eta = [ -1.0;-1.0;1.0;-1.0;0.0;0.0;0.47683362468102025;-0.7384168123405102;-0.7384168123405102;-0.6990558469032424;-0.15047207654837885;-0.15047207654837885;-1.0;-1.0;0.5773502691896257;-0.5773502691896257;-0.5773502691896257;0.5773502691896257]
        Qxi = [ -0.04761904761904762    -0.0027520653248699987   0.0033858720994697717  -0.01185333699894609     -0.010163185600013754   0.0372501623957716      0.01510461491015479      0.09066887157242541     0.01770555039706202    -0.046005570956720566     0.03187860798950366   -0.043324783321963024    0.005265306134989742    0.04045232116025869    -0.006114432317809702   -0.007212217853598104   -0.04928016254228572   -0.017386504124380954; 
                 0.0027520653248699987   0.04761904761904769    -0.0033858720994696754   0.011853336998946341    -0.0372501623957717     0.01016318560001378    -0.015104614910154824    -0.017705550397061898   -0.09066887157242519     0.04600557095672029      0.04332478332196299   -0.03187860798950375    -0.04045232116025874    -0.005265306134989575    0.017386504124380836    0.0492801625422857      0.007212217853598071   0.006114432317809658; 
                 0.006137937424339789   -0.006137937424339886   -6.938893903907228e-17   1.849092981024189e-16   -0.04910349939471838    0.049103499394718114    3.274872078959011e-17   -0.002600935486907097    0.0026009354869070437  -9.670469316082602e-17   -0.002680787634757469   0.0026807876347573574  -0.0010977855357879867   0.0010977855357879368   0.08973248370254419     0.022651810259370665   -0.022651810259370735  -0.08973248370254444;  
                 0.01185333699894609    -0.011853336998946341   -1.849092981024189e-16   0.0                      0.006760605595730283  -0.00676060559573044    -2.4025482089227852e-17  -0.010403741947627677    0.010403741947627946   -1.8065658709754726e-16  -0.010723150539030113   0.010723150539030024    0.06159174576423358    -0.061591745764233104   -0.0016072695760220156  -0.005998411719174445    0.005998411719174641   0.0016072695760224647;
                 0.010163185600013754   -0.0008450756994662634   0.011008261299480251   -0.006760605595730283     0.3047619047619047    -0.013521211191460747    0.00780354817788446     -0.03029011060897446     0.018207290125512407    0.07432473511527428     -0.3912481811242079     0.085047885654304      -0.015833079895574892   -0.007050795609270062   -0.0460406512821372      0.015551094482096097   -0.005443526033247737  -0.009834668176400075; 
                 0.000845075699466534   -0.01016318560001378    -0.011008261299480147    0.00676060559573044      0.013521211191460747  -0.3047619047619047     -0.00780354817788411     -0.018207290125512008    0.03029011060897473    -0.07432473511527442     -0.0850478856543037     0.391248181124208       0.0070507956092701355   0.01583307989557466     0.00983466817640005     0.005443526033248038   -0.015551094482096062   0.04604065128213741;  
                -0.01510461491015479     0.015104614910154824   -3.274872078959011e-17   2.4025482089227852e-17  -0.00780354817788446    0.00780354817788411     0.0                      0.04347366358714667    -0.04347366358714709     3.2774429647298597e-16   0.21641696133691904   -0.21641696133691854     0.005068553221277185   -0.005068553221277551    0.3562378853523459     -0.026866685425063253    0.026866685425063333  -0.35623788535234585;  
                -0.09066887157242541     0.017705550397061898    0.002600935486907097    0.010403741947627677     0.03029011060897446    0.018207290125512008   -0.04347366358714667      0.0                    -0.08694732717429461     0.33762211770012396     -0.10199925625754475    0.12120515636320531    -0.02809349098352153     0.06330896571324222     0.019462956604281278    0.024531509825558732   -0.29292891963910367   -0.0012268055584588838;
                -0.01770555039706202     0.09066887157242519    -0.0026009354869070437  -0.010403741947627946    -0.018207290125512407  -0.03029011060897473     0.04347366358714709      0.08694732717429461     0.0                    -0.3376221177001243      -0.12120515636320613    0.10199925625754419    -0.06330896571324181     0.02809349098352212     0.0012268055584588032   0.292928919639104      -0.02453150982555814   -0.01946295660428096;  
                 0.046005570956720566   -0.04600557095672029     9.670469316082602e-17   1.8065658709754726e-16  -0.07432473511527428    0.07432473511527442    -3.2774429647298597e-16  -0.33762211770012396     0.3376221177001243      0.0                      0.2264458701306709    -0.226445870130671       0.04827533155453254    -0.048275331554532765    0.004685307967556511   -0.070233617761464       0.07023361776146406   -0.004685307967556302; 
                -0.03187860798950366    -0.04332478332196299     0.002680787634757469    0.010723150539030113     0.3912481811242079     0.0850478856543037     -0.21641696133691904      0.10199925625754475     0.12120515636320613    -0.2264458701306709       0.0                   -0.4528917402613419      0.014095168880361504    0.022201467342557984    0.03581831583653548     0.08409364739106773     0.017516159375001384   0.08432878664182546;  
                 0.043324783321963024    0.03187860798950375    -0.0026807876347573574  -0.010723150539030024    -0.085047885654304     -0.391248181124208       0.21641696133691854     -0.12120515636320531    -0.10199925625754419     0.226445870130671        0.4528917402613419     0.0                    -0.022201467342557606   -0.014095168880362113   -0.0843287866418258     -0.017516159375001367   -0.08409364739106816   -0.03581831583653561;  
                -0.005265306134989742    0.04045232116025874     0.0010977855357879867  -0.06159174576423358      0.015833079895574892  -0.0070507956092701355  -0.005068553221277185     0.02809349098352153     0.06330896571324181    -0.04827533155453254     -0.014095168880361504   0.022201467342557606    0.0                     0.014863513143176736   -0.0031318566380212354  -0.03199218463818146    -0.011688248095117662   0.002308566761864838; 
                -0.04045232116025869     0.005265306134989575   -0.0010977855357879368   0.061591745764233104     0.007050795609270062  -0.01583307989557466     0.005068553221277551    -0.06330896571324222    -0.02809349098352212     0.048275331554532765    -0.022201467342557984   0.014095168880362113   -0.014863513143176736    0.0                    -0.002308566761865418    0.011688248095117664    0.031992184638181424   0.003131856638021487; 
                 0.006114432317809702    0.0007270557674923205  -0.022131757880131754    0.0016072695760220156    0.04604065128213742   -0.00983466817640005    -0.3562378853523459      -0.019462956604281278   -0.0012268055584588032  -0.004685307967556511    -0.03581831583653548    0.0843287866418258      0.0031318566380212354   0.002308566761865418    0.25714285714285695    -0.0074317565715885684  -0.008556391457096368   0.06398436927636232;  
                 0.007212217853598104    0.018320563280126802   -0.0045382503674974515   0.005998411719174445    -0.015551094482095955  -0.005443526033248038    0.026866685425063253    -0.024531509825558732   -0.292928919639104       0.070233617761464       -0.08409364739106773    0.017516159375001367    0.03199218463818146    -0.011688248095117664    0.007431756571588309    0.25714285714285684     0.004617133523730635  -0.008556391457096371; 
                -0.01832056328012671    -0.007212217853598071    0.004538250367497578   -0.005998411719174641     0.005443526033247737   0.015551094482095844   -0.026866685425063333     0.29292891963910367     0.02453150982555814    -0.07023361776146406     -0.017516159375001384   0.08409364739106816     0.011688248095117662   -0.031992184638181424    0.008556391457096368   -0.004617133523730635   -0.25714285714285695   -0.007431756571588442; 
                -0.000727055767492258   -0.006114432317809658    0.022131757880131935   -0.0016072695760224647    0.009834668176400075  -0.04604065128213755     0.35623788535234585      0.0012268055584588838   0.01946295660428096     0.004685307967556302    -0.08432878664182546    0.03581831583653561    -0.002308566761864838   -0.003131856638021487   -0.06398436927636232     0.008556391457096371    0.007431756571588701  -0.25714285714285684]
        Qeta = [ -0.04761904761904769     0.0033858720994697925   -0.0027520653248699557   0.03725016239577178   -0.010163185600013724  -0.011853336998946395     0.017705550397061832    0.09066887157242524     0.015104614910155032   -0.043324783321963205   0.03187860798950363   -0.04600557095672039     -0.017386504124380933   -0.04928016254228567    -0.00721221785359793    -0.0061144323178098274   0.04045232116025874     0.0052653061349895395;
                  0.006137937424339769    6.938893903907228e-17   -0.006137937424339705    0.04910349939471815   -0.04910349939471806    4.9764879717084654e-17   0.0026009354869071227  -0.0026009354869069926  -1.317305639569888e-16   0.002680787634757201  -0.002680787634757247   6.375108774214766e-17   -0.08973248370254452    -0.022651810259370443    0.022651810259370443    0.08973248370254452     0.001097785535788108   -0.0010977855357881556;
                  0.0027520653248699557  -0.003385872099469856     0.04761904761904762     0.010163185600013842  -0.037250162395771995   0.011853336998946305    -0.0906688715724251     -0.01770555039706225    -0.015104614910154931   -0.031878607989503926   0.04332478332196289    0.04600557095672034      0.006114432317809946    0.0072122178535978885   0.04928016254228564     0.017386504124381093   -0.005265306134989765   -0.040452321160258604; 
                  0.0008450756994661905  -0.011008261299480019    -0.010163185600013842   -0.3047619047619047     0.013521211191460871   0.006760605595730688     0.03029011060897458    -0.018207290125511748   -0.007803548177884178    0.39124818112420756   -0.08504788565430436   -0.07432473511527428      0.04604065128213731    -0.015551094482095965    0.005443526033247556    0.009834668176400317    0.015833079895574635    0.007050795609269937; 
                  0.010163185600013724    0.011008261299480092    -0.000845075699466135   -0.013521211191460871   0.3047619047619047    -0.006760605595730434     0.018207290125512476   -0.030290110608975032    0.007803548177884179    0.08504788565430378   -0.3912481811242075     0.07432473511527422     -0.009834668176400019   -0.005443526033247702    0.01555109448209615    -0.04604065128213739    -0.007050795609269956   -0.015833079895574736; 
                  0.011853336998946395   -4.9764879717084654e-17  -0.011853336998946305   -0.006760605595730688   0.006760605595730434   0.0                      0.01040374194762807    -0.01040374194762789    -1.194790794079026e-16   0.01072315053902968   -0.010723150539030007  -2.7994100093575724e-16   0.0016072695760225124   0.005998411719174521   -0.005998411719174464   -0.0016072695760219878  -0.061591745764233284    0.06159174576423345;  
                 -0.017705550397061832   -0.0026009354869071227    0.0906688715724251     -0.03029011060897458   -0.018207290125512476  -0.01040374194762807      0.0                     0.0869473271742934      0.04347366358714655     0.10199925625754389   -0.12120515636320585   -0.3376221177001245      -0.019462956604281025   -0.024531509825558576    0.2929289196391041      0.0012268055584586223   0.02809349098352182    -0.06330896571324196;  
                 -0.09066887157242524     0.0026009354869069926    0.01770555039706225     0.018207290125511748   0.030290110608975032   0.01040374194762789     -0.0869473271742934      0.0                    -0.04347366358714739     0.12120515636320536   -0.10199925625754466    0.33762211770012396     -0.0012268055584581433  -0.2929289196391036      0.024531509825558212    0.019462956604281247    0.06330896571324213    -0.028093490983522453; 
                 -0.015104614910155032    1.317305639569888e-16    0.015104614910154931    0.007803548177884178  -0.007803548177884179   1.194790794079026e-16   -0.04347366358714655     0.04347366358714739     0.0                    -0.2164169613369192     0.21641696133691865    3.112744437205883e-16   -0.3562378853523459      0.026866685425063607   -0.026866685425063416    0.3562378853523455     -0.005068553221277184    0.005068553221277279; 
                  0.043324783321963205   -0.002680787634757201     0.031878607989503926   -0.39124818112420756   -0.08504788565430378   -0.01072315053902968     -0.10199925625754389    -0.12120515636320536     0.2164169613369192      0.0                    0.4528917402613419     0.22644587013067075     -0.03581831583653539    -0.08409364739106825    -0.01751615937500145    -0.08432878664182551    -0.014095168880361518   -0.0222014673425579;   
                 -0.03187860798950363     0.002680787634757247    -0.04332478332196289     0.08504788565430436    0.3912481811242075     0.010723150539030007     0.12120515636320585     0.10199925625754466    -0.21641696133691865    -0.4528917402613419     0.0                   -0.22644587013067102      0.0843287866418258      0.017516159375001387    0.08409364739106794     0.035818315836535095    0.02220146734255787     0.014095168880361669; 
                  0.04600557095672039    -6.375108774214766e-17   -0.04600557095672034     0.07432473511527428   -0.07432473511527422    2.7994100093575724e-16   0.3376221177001245     -0.33762211770012396    -3.112744437205883e-16  -0.22644587013067075    0.22644587013067102    0.0                     -0.004685307967556292    0.07023361776146407    -0.07023361776146408     0.004685307967556418   -0.04827533155453255     0.04827533155453268;  
                 -0.0007270557674922216   0.022131757880132094    -0.006114432317809946   -0.04604065128213753    0.009834668176400019  -0.0016072695760225124    0.019462956604281025    0.0012268055584581433   0.3562378853523459      0.03581831583653539   -0.0843287866418258     0.004685307967556292    -0.25714285714285695     0.007431756571588385    0.008556391457096333   -0.06398436927636245    -0.0031318566380213364  -0.0023085667618654767;
                 -0.01832056328012683     0.004538250367497228    -0.0072122178535978885   0.015551094482095823   0.005443526033247702  -0.005998411719174521     0.024531509825558576    0.2929289196391036     -0.026866685425063607    0.08409364739106825   -0.017516159375001387  -0.07023361776146407     -0.007431756571588126   -0.25714285714285684    -0.004617133523730501    0.008556391457096264   -0.03199218463818102     0.011688248095117398; 
                  0.00721221785359793    -0.004538250367497285     0.018320563280126788   -0.005443526033247556  -0.01555109448209593    0.005998411719174464    -0.2929289196391041     -0.024531509825558212    0.026866685425063416    0.01751615937500145   -0.08409364739106794    0.07023361776146408     -0.008556391457096333    0.004617133523730501    0.25714285714285695     0.007431756571588237   -0.011688248095117584    0.0319921846381812;   
                  0.0061144323178098274  -0.022131757880132025     0.000727055767492121   -0.009834668176400317   0.04604065128213753    0.0016072695760219878   -0.0012268055584586223  -0.019462956604281247   -0.3562378853523455      0.08432878664182551   -0.035818315836535095  -0.004685307967556418     0.06398436927636245    -0.008556391457096264   -0.0074317565715884965   0.25714285714285684     0.0023085667618653635   0.003131856638021382; 
                 -0.04045232116025874    -0.001097785535788108     0.005265306134989765   -0.015833079895574635   0.007050795609269956   0.061591745764233284    -0.02809349098352182    -0.06330896571324213     0.005068553221277184    0.014095168880361518  -0.02220146734255787    0.04827533155453255      0.0031318566380213364   0.03199218463818102     0.011688248095117584   -0.0023085667618653635   0.0                    -0.014863513143176958; 
                 -0.0052653061349895395   0.0010977855357881556    0.040452321160258604   -0.007050795609269937   0.015833079895574736  -0.06159174576423345      0.06330896571324196     0.028093490983522453   -0.005068553221277279    0.0222014673425579    -0.014095168880361669  -0.04827533155453268      0.0023085667618654767  -0.011688248095117398   -0.0319921846381812     -0.003131856638021382    0.014863513143176958    0.0]
        P = [ 0.012698412698412695  0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.012698412698412695  0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.012698412698412695  0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.05079365079365077  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.05079365079365077  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.05079365079365077  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.2023354595827503  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.2023354595827503  0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.2023354595827503  0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.3151248578775673  0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.3151248578775673  0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.3151248578775673  0.0                  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.04285714285714284  0.0                  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.04285714285714284  0.0                  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.04285714285714284  0.0                  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.04285714285714284  0.0                  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.04285714285714284  0.0;                
              0.0                   0.0                   0.0                   0.0                  0.0                  0.0                  0.0                 0.0                 0.0                 0.0                 0.0                 0.0                 0.0                  0.0                  0.0                  0.0                  0.0                  0.04285714285714284]
        Exi  = Qxi + transpose(Qxi)
        Eeta = Qeta + transpose(Qeta)
    else 
        println("p = ",p," is not included for triangle gamma operators")
    end 
    return xi, eta, P, Qxi, Qeta, Exi, Eeta
end

end 

